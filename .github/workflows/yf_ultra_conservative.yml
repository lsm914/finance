name: YF Ultra Conservative Screener v2

on:
  workflow_dispatch: {}         # 수동 실행
  schedule:                     # 매주 월요일 01:00 KST (UTC 일요일 16:00)
    - cron: "0 16 * * 0"

jobs:
  shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard_idx: [0,1,2,3,4,5,6,7]
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      # 🔥 과거 산출물/잔여물 전부 제거 (클린 스타트)
      - name: Clean workspace
        run: |
          rm -rf artifacts
          rm -rf artifacts_flat
          mkdir -p artifacts
          mkdir -p data
          if [ ! -f data/nasdaq_tickers.csv ]; then
            echo "ticker" > data/nasdaq_tickers.csv
            printf "AAPL\nMSFT\nGOOGL\n" >> data/nasdaq_tickers.csv
          fi

      - name: Run shard ${{ matrix.shard_idx }}
        run: |
          python value_screen_yf_ultra_conservative.py \
            --tickers_csv data/nasdaq_tickers.csv \
            --shard_idx ${{ matrix.shard_idx }} \
            --num_shards 8 \
            --out_csv artifacts/shard_${{ matrix.shard_idx }}.csv

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_idx }}
          path: artifacts/shard_${{ matrix.shard_idx }}.csv
          if-no-files-found: error

  merge:
    runs-on: ubuntu-latest
    needs: shard

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      # 🔥 이전 다운로드/산출물 폴더 삭제 (이번 런의 아티팩트만 사용)
      - name: Clean artifacts dir
        run: |
          rm -rf artifacts
          mkdir -p artifacts

      # 이번 런의 shard-* 아티팩트만 평탄화하여 다운로드
      - name: Download all shard artifacts (flatten)
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: artifacts
          merge-multiple: true

      - name: List merged artifacts
        run: |
          echo "=== artifacts (should be only this run) ==="
          ls -al artifacts

      # ✅ 이번 런에서 받은 아티팩트만 읽도록 --input_dir=artifacts 지정
      - name: Merge shards & compute indices
        run: |
          python merge_shards.py \
            --input_dir artifacts \
            --out_all all_nasdaq_value_screen.csv

      - name: Upload final CSV
        uses: actions/upload-artifact@v4
        with:
          name: yf-ultra-v2-results
          path: all_nasdaq_value_screen.csv

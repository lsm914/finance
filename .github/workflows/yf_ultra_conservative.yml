name: YF Ultra Conservative Screener v2

on:
  workflow_dispatch: {}
  schedule:
    # 매주 월요일 01:00 KST (UTC 16:00 일요일)
    - cron: '0 16 * * 0'

jobs:
  shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard_idx: [0,1,2,3,4,5,6,7]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      - name: Prepare tickers
        run: |
          mkdir -p data artifacts
          # 예시용 티커 파일(있으면 건너뜀)
          if [ ! -f data/nasdaq_tickers.csv ]; then
            echo "ticker" > data/nasdaq_tickers.csv
            printf "AAPL\nMSFT\nGOOGL\n" >> data/nasdaq_tickers.csv
          fi

      - name: Run shard ${{ matrix.shard_idx }}
        run: |
          python value_screen_yf_ultra_conservative.py \
            --tickers_csv data/nasdaq_tickers.csv \
            --shard_idx ${{ matrix.shard_idx }} \
            --num_shards 8 \
            --out_csv artifacts/shard_${{ matrix.shard_idx }}.csv \
            --resume

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_idx }}
          path: artifacts/shard_${{ matrix.shard_idx }}.csv
          if-no-files-found: error

  merge:
    runs-on: ubuntu-latest
    needs: shard
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Download all shard artifacts (flatten)
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: artifacts
          merge-multiple: true

      - name: List merged artifacts
        run: |
          echo "=== artifacts ==="
          ls -al artifacts

      - name: Merge shards & compute indices
        run: |
          python merge_shards.py \
            --input_dir artifacts \
            --out_all all_nasdaq_value_screen.csv

      - name: Upload final CSVs
        uses: actions/upload-artifact@v4
        with:
          name: yf-ultra-v2-results
          path: |
            all_nasdaq_value_screen.csv

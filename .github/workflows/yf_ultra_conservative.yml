name: YF Ultra Conservative Screener v2

on:
  workflow_dispatch: {}
  schedule:
    # 매주 월요일 01:00 KST (UTC 16:00 일요일)
    - cron: '0 16 * * 0'

jobs:
  shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard_idx: [0,1,2,3,4,5,6,7]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      - name: Prepare tickers
        run: |
          # 예시: repo 내 data/nasdaq_tickers.csv (컬럼명: ticker)
          test -f data/nasdaq_tickers.csv || {
            echo "ticker" > data/nasdaq_tickers.csv
            echo "AAPL" >> data/nasdaq_tickers.csv
            echo "MSFT" >> data/nasdaq_tickers.csv
            echo "GOOGL" >> data/nasdaq_tickers.csv
          }

      - name: Run shard ${{ matrix.shard_idx }}
        run: |
          mkdir -p artifacts
          python value_screen_yf_ultra_conservative.py             --tickers_csv data/nasdaq_tickers.csv             --shard_idx ${{ matrix.shard_idx }}             --num_shards 8             --out_csv artifacts/shard_${{ matrix.shard_idx }}.csv             --resume

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_idx }}
          path: artifacts/shard_${{ matrix.shard_idx }}.csv

  merge:
    runs-on: ubuntu-latest
    needs: shard
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set up Python for merge
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install merge deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Merge shards & compute indices
        run: |
          ls -R artifacts
          # 아티팩트 폴더 구조 평탄화 (actions/download-artifact가 폴더별로 저장)
          mkdir -p artifacts_flat
          find artifacts -type f -name 'shard_*.csv' -exec cp {} artifacts_flat/ \;
          ls artifacts_flat

          python merge_shards.py

      - name: Upload final CSVs
        uses: actions/upload-artifact@v4
        with:
          name: yf-ultra-v2-results
          path: |
            all_nasdaq_value_screen.csv
            sector_summary.csv

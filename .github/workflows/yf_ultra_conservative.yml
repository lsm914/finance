name: YF Ultra Conservative Screener v2

on:
  workflow_dispatch: {}
  # 체이닝으로 실행하려면 아래 주석 해제 대신 update 워크플로우에서 workflow_run 사용
  # schedule:
  #   - cron: "0 16 * * 0"  # 월 01:00 KST (UTC 일 16:00)

jobs:
  shard:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        shard_idx: [0,1,2,3,4,5,6,7]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install yfinance pandas numpy

      - name: Clean & prepare
        run: |
          rm -rf artifacts
          mkdir -p artifacts data
          # data/nasdaq_tickers.csv가 헤더 없이 올 가능성 대비 (없으면 샘플)
          if [ ! -f data/nasdaq_tickers.csv ]; then
            echo "ticker" > data/nasdaq_tickers.csv
            printf "AAPL\nMSFT\nGOOGL\n" >> data/nasdaq_tickers.csv
          fi

      - name: Run shard ${{ matrix.shard_idx }}
        run: |
          python value_screen_yf_ultra_conservative.py \
            --tickers_csv data/nasdaq_tickers.csv \
            --shard_idx ${{ matrix.shard_idx }} \
            --num_shards 8 \
            --out_csv artifacts/shard_${{ matrix.shard_idx }}.csv

      - name: Upload shard artifact
        uses: actions/upload-artifact@v4
        with:
          name: shard-${{ matrix.shard_idx }}
          path: artifacts/shard_${{ matrix.shard_idx }}.csv
          if-no-files-found: error

  merge:
    runs-on: ubuntu-latest
    needs: shard
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy

      - name: Clean artifacts dir
        run: |
          rm -rf artifacts
          mkdir -p artifacts

      - name: Download all shard artifacts (flatten)
        uses: actions/download-artifact@v4
        with:
          pattern: shard-*
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -al artifacts

      - name: Merge shards & compute indices
        run: |
          python merge_shards.py --input_dir artifacts --out_all all_nasdaq_value_screen.csv

      - name: Upload final CSV
        uses: actions/upload-artifact@v4
        with:
          name: yf-ultra-v2-results
          path: all_nasdaq_value_screen.csv
